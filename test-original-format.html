<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Original Format - Mist Commons</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 40px; line-height: 1.6; }
        .container { max-width: 1200px; margin: 0 auto; }
        pre { background: #f5f5f5; padding: 15px; border-radius: 8px; overflow-x: auto; font-size: 12px; max-height: 400px; }
        .section { margin: 30px 0; padding: 20px; border: 1px solid #ddd; border-radius: 8px; }
        .success { color: #28a745; font-weight: bold; }
        .error { color: #dc3545; font-weight: bold; }
        .info { color: #007bff; font-weight: bold; }
        .warning { color: #ffc107; }
        button { padding: 12px 24px; margin: 10px 5px; background: #007cba; color: white; border: none; border-radius: 6px; cursor: pointer; }
        button:hover { background: #005a87; }
        .highlight { background: #e7f3ff; padding: 15px; border-left: 4px solid #007cba; margin: 15px 0; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px; margin: 20px 0; }
        .stat-card { background: #f8f9fa; padding: 15px; border-radius: 8px; text-align: center; border-left: 3px solid #007cba; }
        .stat-number { font-size: 24px; font-weight: bold; color: #007cba; }
        .stat-label { font-size: 14px; color: #666; margin-top: 5px; }
        table { width: 100%; border-collapse: collapse; margin: 15px 0; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; font-size: 13px; }
        th { background-color: #f2f2f2; font-weight: bold; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîÑ Original Format Restored</h1>
        <p>This test validates that your dashboard.php now returns data in the original working format from your Quarry SQL.</p>
        
        <div class="highlight">
            <strong>üîß What Was Fixed:</strong>
            <ul>
                <li>Restored original "rows" array format instead of complex "data" + "statistics"</li>
                <li>Simplified SQL query to match your working Quarry output</li>
                <li>Fixed GPS coordinate extraction from metadata JSON</li>
                <li>Proper camera model detection from EXIF metadata</li>
                <li>Correct file size distribution calculation</li>
            </ul>
        </div>
        
        <div class="section">
            <h2>1. Test Original Format API</h2>
            <button onclick="testOriginalAPI()">Test Real Data (Original Format)</button>
            <button onclick="testMockData()">Test Mock Data</button>
            <div id="api-result"></div>
        </div>
        
        <div class="section">
            <h2>2. Validate Data Processing</h2>
            <button onclick="validateProcessing()">Validate Processing</button>
            <div id="validation-result"></div>
        </div>
        
        <div class="section">
            <h2>3. Sample Row Structure</h2>
            <p>Each row in the "rows" array should have this structure:</p>
            <table>
                <tr><th>Index</th><th>Field</th><th>Description</th><th>Example</th></tr>
                <tr><td>0</td><td>cl_from</td><td>Page ID</td><td>177217223</td></tr>
                <tr><td>1</td><td>category</td><td>Category name</td><td>Vattathil_Waterfalls_Kalladathanni</td></tr>
                <tr><td>2</td><td>filename</td><td>Image filename</td><td>Sample_Photo_1.jpg</td></tr>
                <tr><td>3</td><td>imgdate</td><td>Upload date (YYYYMMDD)</td><td>20251022</td></tr>
                <tr><td>4</td><td>timestamp</td><td>Full timestamp</td><td>20251022151759</td></tr>
                <tr><td>5</td><td>size_bytes</td><td>File size in bytes</td><td>8426871</td></tr>
                <tr><td>6</td><td>metadata</td><td>JSON metadata</td><td>{"data":{"Model":"Canon"}}</td></tr>
                <tr><td>7</td><td>uploader</td><td>Username</td><td>SijiR</td></tr>
            </table>
        </div>
        
        <div class="section">
            <h2>4. Raw API Response</h2>
            <details>
                <summary>Click to view latest API response</summary>
                <pre id="raw-response"></pre>
            </details>
        </div>
    </div>

    <script>
        // Original data processing function that handles "rows" format
        function processOriginalData(jsonData) {
            console.log('Processing original format data:', jsonData);
            
            const rows = jsonData.rows || [];
            if (rows.length === 0) {
                return {
                    stats: { uniqueUsers: 0, totalFiles: 0, uniqueDates: 0, totalSize: 0, avgFileSize: 0, geotaggedFiles: 0 },
                    data: { userContributions: [], sizeDistribution: [], cameraData: [] },
                    geoData: []
                };
            }
            
            // Basic statistics
            const uniqueUsers = new Set(rows.map(r => r[7])).size;
            const totalFiles = rows.length;
            const totalSize = rows.reduce((sum, r) => sum + (parseInt(r[5]) || 0), 0);
            const uniqueDates = new Set(rows.map(r => r[3])).size;
            
            // GPS and metadata processing
            const geoLocations = [];
            const cameraModels = {};
            let geotaggedCount = 0;
            
            rows.forEach(row => {
                try {
                    const metadataJson = row[6];
                    if (metadataJson && metadataJson !== '{}') {
                        const metadata = JSON.parse(metadataJson);
                        
                        // GPS processing
                        const lat = metadata?.data?.GPSLatitude;
                        const lon = metadata?.data?.GPSLongitude;
                        if (lat && lon && !isNaN(parseFloat(lat)) && !isNaN(parseFloat(lon))) {
                            geotaggedCount++;
                            geoLocations.push({
                                lat: parseFloat(lat),
                                lon: parseFloat(lon),
                                filename: row[2],
                                author: row[7]
                            });
                        }
                        
                        // Camera processing
                        const model = metadata?.data?.Model;
                        if (model && model.trim() !== '') {
                            cameraModels[model] = (cameraModels[model] || 0) + 1;
                        }
                    }
                } catch (e) {
                    // Skip invalid metadata
                }
                
                // Filename-based camera detection as fallback
                if (!cameraModels[row[2]]) { // If no camera found yet for this style
                    const filename = row[2].toUpperCase();
                    if (filename.includes('DSC_')) {
                        cameraModels['Nikon DSLR'] = (cameraModels['Nikon DSLR'] || 0) + 1;
                    } else if (filename.includes('IMG_')) {
                        cameraModels['Canon DSLR'] = (cameraModels['Canon DSLR'] || 0) + 1;
                    } else {
                        cameraModels['Unknown Camera'] = (cameraModels['Unknown Camera'] || 0) + 1;
                    }
                }
            });
            
            // User contributions
            const userContributions = {};
            rows.forEach(row => {
                const user = row[7];
                if (!userContributions[user]) {
                    userContributions[user] = { count: 0, size: 0 };
                }
                userContributions[user].count++;
                userContributions[user].size += parseInt(row[5]) || 0;
            });
            
            const userContribArray = Object.entries(userContributions)
                .map(([name, data]) => ({
                    name,
                    files: data.count,
                    sizeMB: (data.size / (1024 * 1024)).toFixed(2)
                }))
                .sort((a, b) => b.files - a.files);
            
            // Size distribution
            const sizeRanges = {
                '< 1 MB': 0,
                '1-5 MB': 0,
                '5-10 MB': 0,
                '10-15 MB': 0,
                '> 15 MB': 0
            };
            
            rows.forEach(row => {
                const sizeMB = (parseInt(row[5]) || 0) / (1024 * 1024);
                if (sizeMB < 1) sizeRanges['< 1 MB']++;
                else if (sizeMB < 5) sizeRanges['1-5 MB']++;
                else if (sizeMB < 10) sizeRanges['5-10 MB']++;
                else if (sizeMB < 15) sizeRanges['10-15 MB']++;
                else sizeRanges['> 15 MB']++;
            });
            
            const sizeDistribution = Object.entries(sizeRanges)
                .map(([range, count]) => ({ range, count }))
                .filter(item => item.count > 0);
            
            const cameraData = Object.entries(cameraModels)
                .map(([model, count]) => ({ model, count }))
                .sort((a, b) => b.count - a.count)
                .slice(0, 10);
            
            return {
                stats: {
                    uniqueUsers,
                    totalFiles,
                    uniqueDates,
                    totalSize,
                    avgFileSize: totalFiles > 0 ? totalSize / totalFiles : 0,
                    geotaggedFiles: geotaggedCount
                },
                data: {
                    userContributions: userContribArray,
                    sizeDistribution,
                    cameraData
                },
                geoData: geoLocations
            };
        }

        function formatBytes(bytes) {
            if (!bytes || bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
        }

        async function testOriginalAPI() {
            const resultDiv = document.getElementById('api-result');
            resultDiv.innerHTML = '<p>üîÑ Testing original format API...</p>';
            
            try {
                const response = await fetch('https://mist.toolforge.org/api/dashboard.php?category=Vattathil_Waterfalls_Kalladathanni&custom=1&refresh=1');
                const data = await response.json();
                
                if (data.success) {
                    resultDiv.innerHTML = `
                        <div class="success">‚úÖ Original Format API Working!</div>
                        <div class="stats-grid">
                            <div class="stat-card">
                                <div class="stat-number">${data.count || 0}</div>
                                <div class="stat-label">Total Records</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-number">${data.rows ? data.rows.length : 0}</div>
                                <div class="stat-label">Rows Length</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-number">${data.query_time_ms || 0}ms</div>
                                <div class="stat-label">Query Time</div>
                            </div>
                        </div>
                        <p><strong>Format:</strong> Original "rows" array format ‚úÖ</p>
                        <p><strong>Row structure:</strong> Each row has ${data.rows && data.rows[0] ? data.rows[0].length : 'N/A'} fields</p>
                    `;
                    
                    document.getElementById('raw-response').textContent = JSON.stringify(data, null, 2);
                } else {
                    resultDiv.innerHTML = `<div class="error">‚ùå API Error: ${data.error}</div>`;
                }
            } catch (error) {
                resultDiv.innerHTML = `<div class="error">‚ùå Network Error: ${error.message}</div>`;
            }
        }

        async function testMockData() {
            const resultDiv = document.getElementById('api-result');
            resultDiv.innerHTML = '<p>üîÑ Testing mock data...</p>';
            
            try {
                const response = await fetch('https://mist.toolforge.org/api/dashboard.php?category=Test&mock=1');
                const data = await response.json();
                
                if (data.success) {
                    resultDiv.innerHTML = `
                        <div class="success">‚úÖ Mock Data API Working!</div>
                        <div class="stats-grid">
                            <div class="stat-card">
                                <div class="stat-number">${data.count || 0}</div>
                                <div class="stat-label">Mock Records</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-number">${data.rows ? data.rows.length : 0}</div>
                                <div class="stat-label">Mock Rows</div>
                            </div>
                        </div>
                        <p><strong>Mock data includes:</strong> GPS coordinates, camera models, various file sizes</p>
                    `;
                } else {
                    resultDiv.innerHTML = `<div class="error">‚ùå Mock API Error: ${data.error}</div>`;
                }
            } catch (error) {
                resultDiv.innerHTML = `<div class="error">‚ùå Network Error: ${error.message}</div>`;
            }
        }

        async function validateProcessing() {
            const resultDiv = document.getElementById('validation-result');
            resultDiv.innerHTML = '<p>üîÑ Validating data processing...</p>';
            
            try {
                // Test with mock data first
                const response = await fetch('https://mist.toolforge.org/api/dashboard.php?category=Test&mock=1');
                const data = await response.json();
                
                if (data.success && data.rows) {
                    const processed = processOriginalData(data);
                    
                    resultDiv.innerHTML = `
                        <div class="success">‚úÖ Data Processing Validation Complete</div>
                        
                        <h3>Raw Data Analysis</h3>
                        <div class="stats-grid">
                            <div class="stat-card">
                                <div class="stat-number">${data.rows.length}</div>
                                <div class="stat-label">Raw Rows</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-number">${data.rows[0] ? data.rows[0].length : 0}</div>
                                <div class="stat-label">Fields per Row</div>
                            </div>
                        </div>
                        
                        <h3>Processed Statistics</h3>
                        <div class="stats-grid">
                            <div class="stat-card">
                                <div class="stat-number">${processed.stats.uniqueUsers}</div>
                                <div class="stat-label">Contributors</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-number">${processed.stats.totalFiles}</div>
                                <div class="stat-label">Total Files</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-number">${processed.stats.geotaggedFiles}</div>
                                <div class="stat-label">GPS Files</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-number">${processed.geoData.length}</div>
                                <div class="stat-label">Valid GPS Points</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-number">${processed.data.cameraData.length}</div>
                                <div class="stat-label">Camera Models</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-number">${formatBytes(processed.stats.totalSize)}</div>
                                <div class="stat-label">Total Size</div>
                            </div>
                        </div>
                        
                        <h3>üì∑ Camera Models Detected</h3>
                        <table>
                            <tr><th>Camera Model</th><th>Count</th></tr>
                            ${processed.data.cameraData.map(camera => 
                                `<tr><td>${camera.model}</td><td>${camera.count}</td></tr>`
                            ).join('')}
                        </table>
                        
                        <h3>üìä File Size Distribution</h3>
                        <table>
                            <tr><th>Size Range</th><th>Count</th></tr>
                            ${processed.data.sizeDistribution.map(size => 
                                `<tr><td>${size.range}</td><td>${size.count}</td></tr>`
                            ).join('')}
                        </table>
                        
                        <h3>üë• Top Contributors</h3>
                        <table>
                            <tr><th>User</th><th>Files</th><th>Size (MB)</th></tr>
                            ${processed.data.userContributions.slice(0, 5).map(user => 
                                `<tr><td>${user.name}</td><td>${user.files}</td><td>${user.sizeMB}</td></tr>`
                            ).join('')}
                        </table>
                        
                        ${processed.geoData.length > 0 ? `
                            <h3>üó∫Ô∏è GPS Coordinates Sample</h3>
                            <table>
                                <tr><th>Filename</th><th>Latitude</th><th>Longitude</th></tr>
                                ${processed.geoData.slice(0, 3).map(geo => 
                                    `<tr><td>${geo.filename}</td><td>${geo.lat.toFixed(6)}</td><td>${geo.lon.toFixed(6)}</td></tr>`
                                ).join('')}
                            </table>
                        ` : '<div class="warning">‚ö†Ô∏è No GPS coordinates found in this dataset</div>'}
                    `;
                } else {
                    resultDiv.innerHTML = `<div class="error">‚ùå Validation failed: ${data.error || 'No rows data'}</div>`;
                }
            } catch (error) {
                resultDiv.innerHTML = `<div class="error">‚ùå Validation error: ${error.message}</div>`;
            }
        }
        
        // Auto-run test on page load
        window.onload = function() {
            testOriginalAPI();
        };
    </script>
</body>
</html>